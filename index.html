<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WebXR AR Plane Detection</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        canvas {
            display: block;
        }

        #ui-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(50, 50, 50, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 5px;
            margin-bottom: 5px;
            border: none;
            border-radius: 3px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        #status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="ui-container">
        <h3>AR Plane Detection</h3>
        
        <div class="filter-group">
            <label>Min Width (m) = X-axis:</label>
            <input type="number" id="min-width" value="0.5" step="0.1" min="0">
        </div>

        <div class="filter-group">
            <label>Min Height (m) = Y-axis:</label>
            <input type="number" id="min-height" value="0.5" step="0.1" min="0">
        </div>

        <div class="filter-group">
            <label>Min Length (m) = Z-axis:</label>
            <input type="number" id="min-length" value="0.5" step="0.1" min="0">
        </div>

        <button id="start-ar">Start AR Session</button>
        
        <div id="status">
            Status: Ready to start
        </div>
    </div>

    <script>
        let xrSession = null;
        let gl = null;
        let xrRefSpace = null;
        let detectedPlanes = new Map();
        let filteredPlanes = new Map();

        function updateStatus(text) {
            document.getElementById('status').textContent = `Status: ${text}`;
        }

        function addToStatus(text) {
            document.getElementById('status').textContent = `Status: ${text}`;
        }

        function filterPlanes() {
            const minWidth = parseFloat(document.getElementById('min-width').value);
            const minHeight = parseFloat(document.getElementById('min-height').value);
            const minLength = parseFloat(document.getElementById('min-length').value);

            filteredPlanes.clear();

            detectedPlanes.forEach((plane, id) => {
                // Size filter
                if (plane.width < minWidth || plane.height < minHeight || plane.center.z < minLength) {
                    return;
                }

                filteredPlanes.set(id, plane);
            });
        }

        // Add event listeners for filters
        document.getElementById('min-width').addEventListener('input', filterPlanes);
        document.getElementById('min-height').addEventListener('input', filterPlanes);
        document.getElementById('min-length').addEventListener('input', filterPlanes);

        document.getElementById('start-ar').addEventListener('click', async () => {
            addToStatus("Start AR button clicked");
            
            if (!navigator.xr) {
                addToStatus("WebXR not supported");
                return;
            }

            addToStatus("Checking immersive-ar support...");
            const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
            addToStatus(`immersive-ar supported: ${isSupported}`);
            
            if (!isSupported) {
                addToStatus("immersive-ar not supported");
                return;
            }

            try {
                addToStatus("Requesting AR session...");

                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['plane-detection', 'dom-overlay']
                });

                addToStatus("AR session created successfully");

                const canvas = document.createElement('canvas');
                document.body.appendChild(canvas);
                gl = canvas.getContext('webgl', { xrCompatible: true });

                addToStatus("WebGL context created");

                await gl.makeXRCompatible();
                addToStatus("WebGL made XR compatible");

                const xrLayer = new XRWebGLLayer(xrSession, gl);
                xrSession.updateRenderState({ baseLayer: xrLayer });

                addToStatus("XR layer set up");

                xrRefSpace = await xrSession.requestReferenceSpace('local');
                addToStatus("Reference space created");

                // Set up plane detection if supported
                if (xrSession.detectedPlanes) {
                    addToStatus("Plane detection available");
                    xrSession.addEventListener('planesdetected', onPlanesDetected);
                } else {
                    addToStatus("Plane detection not available");
                }

                xrSession.requestAnimationFrame(onXRFrame);
                addToStatus("Animation frame requested");

                addToStatus("AR session started successfully");
                
                // Hide UI after session starts
                document.getElementById('ui-container').style.display = 'none';

            } catch (err) {
                addToStatus(`Failed to start AR session: ${err.message}`);
            }
        });

        function onPlanesDetected(event) {
            addToStatus(`Planes detected: ${event.detectedPlanes.length}`);
            event.detectedPlanes.forEach(plane => {
                const planeData = {
                    orientation: plane.orientation,
                    width: plane.width,
                    height: plane.height,
                    center: plane.center,
                    polygon: plane.polygon
                };
                detectedPlanes.set(plane.uuid, planeData);
            });

            filterPlanes();
        }

        function onXRFrame(time, frame) {
            let session = frame.session;
            session.requestAnimationFrame(onXRFrame);

            const pose = frame.getViewerPose(xrRefSpace);
            if (!pose) return;

            const glLayer = session.renderState.baseLayer;
            gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);

            // Clear with green color to test rendering
            gl.clearColor(0, 1, 0, 1);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            // Test rendering - you should see green background
            addToStatus(`Frame rendered at: ${time}`);
        }
    </script>
</body>

</html>